{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}系統監控儀表板 - {{ site_title|default:"Django site admin" }}{% endblock %}

{% block extrahead %}
<style>
.monitoring-dashboard {
    padding: 20px;
    background: white;
    border-radius: 8px;
    margin: 20px 0;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    border-left: 4px solid #007cba;
}

.stat-title {
    font-size: 14px;
    color: #666;
    margin-bottom: 8px;
}

.stat-value {
    font-size: 28px;
    font-weight: bold;
    color: #333;
}

.error-list {
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 4px;
    max-height: 400px;
    overflow-y: auto;
}

.error-item {
    padding: 12px;
    border-bottom: 1px solid #eee;
}

.error-item:last-child {
    border-bottom: none;
}

.error-timestamp {
    color: #999;
    font-size: 12px;
}

.refresh-btn {
    background: #007cba;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 4px;
    cursor: pointer;
    margin-bottom: 20px;
}

.refresh-btn:hover {
    background: #005a87;
}

.loading {
    color: #666;
    font-style: italic;
}
</style>
{% endblock %}

{% block content %}
<div class="monitoring-dashboard">
    <h1>🔍 系統監控儀表板</h1>
    
    <button class="refresh-btn" onclick="refreshStats()">🔄 重新整理資料</button>
    
    <div id="loading" class="loading" style="display: none;">載入中...</div>
    
    <!-- 統計卡片 -->
    <div class="stats-grid" id="statsGrid">
        <div class="stat-card">
            <div class="stat-title">總請求數</div>
            <div class="stat-value" id="totalRequests">-</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-title">成功請求</div>
            <div class="stat-value" id="successRequests" style="color: #28a745;">-</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-title">錯誤請求</div>
            <div class="stat-value" id="errorRequests" style="color: #dc3545;">-</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-title">平均回應時間</div>
            <div class="stat-value" id="avgResponseTime">-</div>
        </div>
    </div>
    
    <!-- 請求方法統計 -->
    <div style="margin-bottom: 30px;">
        <h3>📊 請求方法統計</h3>
        <div id="methodStats"></div>
    </div>
    
    <!-- 狀態碼統計 -->
    <div style="margin-bottom: 30px;">
        <h3>📈 HTTP 狀態碼統計</h3>
        <div id="statusCodeStats"></div>
    </div>
    
    <!-- 最近錯誤 -->
    <div>
        <h3>⚠️ 最近錯誤</h3>
        <div class="error-list" id="errorList">
            <div class="error-item">暫無錯誤記錄</div>
        </div>
    </div>
</div>

<script>
// JavaScript 用於載入監控資料
async function loadMonitoringStats() {
    const loading = document.getElementById('loading');
    loading.style.display = 'block';
    
    try {
        const response = await fetch('/admin/monitoring/api/stats/');
        const result = await response.json();
        
        if (result.status === 'success') {
            updateDashboard(result.data);
        } else {
            console.error('載入統計資料失敗:', result.message);
        }
    } catch (error) {
        console.error('網路錯誤:', error);
    } finally {
        loading.style.display = 'none';
    }
}

function updateDashboard(stats) {
    // 更新統計卡片
    document.getElementById('totalRequests').textContent = stats.total_requests || 0;
    document.getElementById('successRequests').textContent = stats.success_requests || 0;
    document.getElementById('errorRequests').textContent = stats.error_requests || 0;
    document.getElementById('avgResponseTime').textContent = (stats.avg_response_time || 0) + ' ms';
    
    // 更新請求方法統計
    const methodStatsDiv = document.getElementById('methodStats');
    let methodHtml = '';
    for (const [method, count] of Object.entries(stats.request_methods || {})) {
        methodHtml += `<span style="margin-right: 15px; padding: 4px 8px; background: #e9ecef; border-radius: 4px;">${method}: ${count}</span>`;
    }
    methodStatsDiv.innerHTML = methodHtml || '暫無資料';
    
    // 更新狀態碼統計
    const statusCodeStatsDiv = document.getElementById('statusCodeStats');
    let statusHtml = '';
    for (const [code, count] of Object.entries(stats.status_codes || {})) {
        const color = code.startsWith('2') ? '#28a745' : code.startsWith('4') ? '#ffc107' : '#dc3545';
        statusHtml += `<span style="margin-right: 15px; padding: 4px 8px; background: ${color}; color: white; border-radius: 4px;">${code}: ${count}</span>`;
    }
    statusCodeStatsDiv.innerHTML = statusHtml || '暫無資料';
    
    // 更新錯誤列表
    const errorList = document.getElementById('errorList');
    if (stats.recent_errors && stats.recent_errors.length > 0) {
        let errorHtml = '';
        stats.recent_errors.forEach(error => {
            errorHtml += `
                <div class="error-item">
                    <div class="error-timestamp">${error.timestamp}</div>
                    <div><strong>${error.module}:</strong> ${error.message}</div>
                </div>
            `;
        });
        errorList.innerHTML = errorHtml;
    } else {
        errorList.innerHTML = '<div class="error-item">暫無錯誤記錄</div>';
    }
}

function refreshStats() {
    loadMonitoringStats();
}

// 頁面載入時自動載入資料
document.addEventListener('DOMContentLoaded', loadMonitoringStats);

// 每 30 秒自動重新整理
setInterval(loadMonitoringStats, 30000);
</script>
{% endblock %}
