{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}ç³»çµ±ç›£æ§å„€è¡¨æ¿ - {{ site_title|default:"Django site admin" }}{% endblock %}

{% block extrahead %}
<style>
.monitoring-dashboard {
    padding: 20px;
    background: white;
    border-radius: 8px;
    margin: 20px 0;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    border-left: 4px solid #007cba;
}

.stat-title {
    font-size: 14px;
    color: #666;
    margin-bottom: 8px;
}

.stat-value {
    font-size: 28px;
    font-weight: bold;
    color: #333;
}

.error-list {
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 4px;
    max-height: 400px;
    overflow-y: auto;
}

.error-item {
    padding: 12px;
    border-bottom: 1px solid #eee;
}

.error-item:last-child {
    border-bottom: none;
}

.error-timestamp {
    color: #999;
    font-size: 12px;
}

.refresh-btn {
    background: #007cba;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 4px;
    cursor: pointer;
    margin-bottom: 20px;
}

.refresh-btn:hover {
    background: #005a87;
}

.loading {
    color: #666;
    font-style: italic;
}
</style>
{% endblock %}

{% block content %}
<div class="monitoring-dashboard">
    <h1>ğŸ” ç³»çµ±ç›£æ§å„€è¡¨æ¿</h1>
    
    <button class="refresh-btn" onclick="refreshStats()">ğŸ”„ é‡æ–°æ•´ç†è³‡æ–™</button>
    
    <div id="loading" class="loading" style="display: none;">è¼‰å…¥ä¸­...</div>
    
    <!-- çµ±è¨ˆå¡ç‰‡ -->
    <div class="stats-grid" id="statsGrid">
        <div class="stat-card">
            <div class="stat-title">ç¸½è«‹æ±‚æ•¸</div>
            <div class="stat-value" id="totalRequests">-</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-title">æˆåŠŸè«‹æ±‚</div>
            <div class="stat-value" id="successRequests" style="color: #28a745;">-</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-title">éŒ¯èª¤è«‹æ±‚</div>
            <div class="stat-value" id="errorRequests" style="color: #dc3545;">-</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-title">å¹³å‡å›æ‡‰æ™‚é–“</div>
            <div class="stat-value" id="avgResponseTime">-</div>
        </div>
    </div>
    
    <!-- è«‹æ±‚æ–¹æ³•çµ±è¨ˆ -->
    <div style="margin-bottom: 30px;">
        <h3>ğŸ“Š è«‹æ±‚æ–¹æ³•çµ±è¨ˆ</h3>
        <div id="methodStats"></div>
    </div>
    
    <!-- ç‹€æ…‹ç¢¼çµ±è¨ˆ -->
    <div style="margin-bottom: 30px;">
        <h3>ğŸ“ˆ HTTP ç‹€æ…‹ç¢¼çµ±è¨ˆ</h3>
        <div id="statusCodeStats"></div>
    </div>
    
    <!-- æœ€è¿‘éŒ¯èª¤ -->
    <div>
        <h3>âš ï¸ æœ€è¿‘éŒ¯èª¤</h3>
        <div class="error-list" id="errorList">
            <div class="error-item">æš«ç„¡éŒ¯èª¤è¨˜éŒ„</div>
        </div>
    </div>
</div>

<script>
// JavaScript ç”¨æ–¼è¼‰å…¥ç›£æ§è³‡æ–™
async function loadMonitoringStats() {
    const loading = document.getElementById('loading');
    loading.style.display = 'block';
    
    try {
        const response = await fetch('/admin/monitoring/api/stats/');
        const result = await response.json();
        
        if (result.status === 'success') {
            updateDashboard(result.data);
        } else {
            console.error('è¼‰å…¥çµ±è¨ˆè³‡æ–™å¤±æ•—:', result.message);
        }
    } catch (error) {
        console.error('ç¶²è·¯éŒ¯èª¤:', error);
    } finally {
        loading.style.display = 'none';
    }
}

function updateDashboard(stats) {
    // æ›´æ–°çµ±è¨ˆå¡ç‰‡
    document.getElementById('totalRequests').textContent = stats.total_requests || 0;
    document.getElementById('successRequests').textContent = stats.success_requests || 0;
    document.getElementById('errorRequests').textContent = stats.error_requests || 0;
    document.getElementById('avgResponseTime').textContent = (stats.avg_response_time || 0) + ' ms';
    
    // æ›´æ–°è«‹æ±‚æ–¹æ³•çµ±è¨ˆ
    const methodStatsDiv = document.getElementById('methodStats');
    let methodHtml = '';
    for (const [method, count] of Object.entries(stats.request_methods || {})) {
        methodHtml += `<span style="margin-right: 15px; padding: 4px 8px; background: #e9ecef; border-radius: 4px;">${method}: ${count}</span>`;
    }
    methodStatsDiv.innerHTML = methodHtml || 'æš«ç„¡è³‡æ–™';
    
    // æ›´æ–°ç‹€æ…‹ç¢¼çµ±è¨ˆ
    const statusCodeStatsDiv = document.getElementById('statusCodeStats');
    let statusHtml = '';
    for (const [code, count] of Object.entries(stats.status_codes || {})) {
        const color = code.startsWith('2') ? '#28a745' : code.startsWith('4') ? '#ffc107' : '#dc3545';
        statusHtml += `<span style="margin-right: 15px; padding: 4px 8px; background: ${color}; color: white; border-radius: 4px;">${code}: ${count}</span>`;
    }
    statusCodeStatsDiv.innerHTML = statusHtml || 'æš«ç„¡è³‡æ–™';
    
    // æ›´æ–°éŒ¯èª¤åˆ—è¡¨
    const errorList = document.getElementById('errorList');
    if (stats.recent_errors && stats.recent_errors.length > 0) {
        let errorHtml = '';
        stats.recent_errors.forEach(error => {
            errorHtml += `
                <div class="error-item">
                    <div class="error-timestamp">${error.timestamp}</div>
                    <div><strong>${error.module}:</strong> ${error.message}</div>
                </div>
            `;
        });
        errorList.innerHTML = errorHtml;
    } else {
        errorList.innerHTML = '<div class="error-item">æš«ç„¡éŒ¯èª¤è¨˜éŒ„</div>';
    }
}

function refreshStats() {
    loadMonitoringStats();
}

// é é¢è¼‰å…¥æ™‚è‡ªå‹•è¼‰å…¥è³‡æ–™
document.addEventListener('DOMContentLoaded', loadMonitoringStats);

// æ¯ 30 ç§’è‡ªå‹•é‡æ–°æ•´ç†
setInterval(loadMonitoringStats, 30000);
</script>
{% endblock %}
