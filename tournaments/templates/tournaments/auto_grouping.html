{% extends 'tournaments/base.html' %}
{% load static %}

{% block title %}自動隨機分組 - {{ tournament.name }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h1>自動隨機分組</h1>
            <h2>{{ tournament.name }}</h2>
        </div>
        <div>
            <span class="badge badge-danger">
                <i class="fas fa-shield-alt"></i> 僅限超級管理員
            </span>
        </div>
    </div>
    
    <!-- 賽事基本資訊 -->
    <div class="alert alert-info mb-4">
        <h5><i class="fas fa-info-circle"></i> 管理員功能說明</h5>
        <p>此功能僅限超級管理員使用，可以自動隨機分配參賽隊伍到各個分組。</p>
        <p><strong>注意：</strong>執行分組操作將會清除現有分組並重新分配，請謹慎使用。</p>
    </div>
    
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">賽事資訊</h5>
            <div class="row">
                <div class="col-md-6">
                    <p><strong>賽制：</strong>{{ tournament.get_format_display }}</p>
                    <p><strong>參賽隊伍：</strong>{{ num_teams }} 支</p>
                </div>
                <div class="col-md-6">
                    <p><strong>狀態：</strong>{{ tournament.get_status_display }}</p>
                    {% if existing_groups.count > 0 %}
                    <p><strong>現有分組：</strong>{{ existing_groups.count }} 組</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {% if existing_groups.count > 0 %}
    <!-- 現有分組資訊 -->
    <div class="alert alert-warning">
        <h5><i class="fas fa-exclamation-triangle"></i> 注意</h5>
        <p>此賽事已有 {{ existing_groups.count }} 個分組，執行自動分組將會<strong>清除現有分組</strong>並重新分配。</p>
        
        <h6>現有分組：</h6>
        {% for group in existing_groups %}
        <div class="mb-2">
            <strong>{{ group.name }}：</strong>
            {% for team in group.teams.all %}
                <span class="badge badge-secondary">{{ team.name }}</span>
            {% endfor %}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- 參賽隊伍列表 -->
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">參賽隊伍 ({{ num_teams }})</h5>
            {% if teams %}
            <div class="row">
                {% for team in teams %}
                <div class="col-md-3 col-sm-6 mb-2">
                    <span class="badge badge-primary">{{ team.name }}</span>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="text-muted">目前沒有參賽隊伍</p>
            {% endif %}
        </div>
    </div>

    {% if num_teams >= 2 %}
    <!-- 分組設定 -->
    <div class="card">
        <div class="card-body">
            <h5 class="card-title">分組設定</h5>
            
            <!-- 建議分組方案 -->
            <div class="mb-4">
                <h6>建議分組方案：</h6>
                {% for suggestion in suggested_groups %}
                <div class="alert alert-info">
                    <strong>{{ suggestion.description }}</strong>
                    <small class="text-muted">- 每組 {{ suggestion.teams_per_group }} 支隊伍</small>
                </div>
                {% endfor %}
            </div>

            <!-- 分組表單 -->
            <form method="post" onsubmit="return confirmGrouping()">
                {% csrf_token %}
                
                <div class="form-group">
                    <label for="num_groups">選擇分組數量：</label>
                    <select class="form-control" id="num_groups" name="num_groups" onchange="updateGroupPreview()">
                        <option value="2">2 組</option>
                        <option value="3">3 組</option>
                        <option value="4">4 組</option>
                        <option value="5">5 組</option>
                        <option value="6">6 組</option>
                        <option value="8">8 組</option>
                    </select>
                </div>

                <!-- 分組預覽 -->
                <div class="alert alert-light" id="group-preview">
                    <strong>分組預覽：</strong>
                    <span id="preview-text">2 組，將平均分配隊伍</span>
                </div>

                <div class="form-group">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="confirm_random" required>
                        <label class="form-check-label" for="confirm_random">
                            我了解此操作將<strong>隨機分配</strong>隊伍到各組
                            {% if existing_groups.count > 0 %}
                            ，並會<strong>清除現有分組</strong>
                            {% endif %}
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-random"></i> 開始自動分組
                    </button>
                    <a href="{% url 'tournament_detail' tournament.id %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> 返回賽事
                    </a>
                </div>
            </form>
        </div>
    </div>
    {% else %}
    <div class="alert alert-warning">
        <h5><i class="fas fa-exclamation-triangle"></i> 無法進行分組</h5>
        <p>至少需要 2 支參賽隊伍才能進行分組。請先添加參賽隊伍。</p>
        <a href="{% url 'tournament_detail' tournament.id %}" class="btn btn-primary">返回賽事</a>
    </div>
    {% endif %}
</div>

<script>
function updateGroupPreview() {
    const numGroups = document.getElementById('num_groups').value;
    document.getElementById('preview-text').textContent = 
        `${numGroups} 組，將平均分配隊伍`;
}

function confirmGrouping() {
    const numGroups = document.getElementById('num_groups').value;
    return confirm(`確定要創建 ${numGroups} 個分組並隨機分配隊伍嗎？`);
}
</script>

{% endblock %}
