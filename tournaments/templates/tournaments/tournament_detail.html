{% extends 'tournaments/base.html' %}

{% block title %}{{ tournament.name }} - 賽事詳情{% endblock %}

{% block content %}
<style>
    /* 強制設定隊伍名稱為清晰的深色，完全移除任何陰影效果 */
    .team-name-black {
        color: #343a40 !important;
        font-weight: 600 !important;
        text-shadow: none !important;
        -webkit-text-stroke: 0 !important;
        text-rendering: optimizeLegibility !important;
        -webkit-font-smoothing: antialiased !important;
        -moz-osx-font-smoothing: grayscale !important;
    }
    
    /* 更具體的選擇器 */
    table.table tbody tr td strong.team-name-black {
        color: #343a40 !important;
        font-weight: 600 !important;
        text-shadow: none !important;
        -webkit-text-stroke: 0 !important;
        text-rendering: optimizeLegibility !important;
        -webkit-font-smoothing: antialiased !important;
        -moz-osx-font-smoothing: grayscale !important;
    }
    
    /* 賽程中的隊伍名稱 */
    .card-body span.team-name-black {
        color: #343a40 !important;
        font-weight: 600 !important;
        text-shadow: none !important;
        -webkit-text-stroke: 0 !important;
        text-rendering: optimizeLegibility !important;
        -webkit-font-smoothing: antialiased !important;
        -moz-osx-font-smoothing: grayscale !important;
    }
    
    /* 完成的比賽卡片樣式 */
    .card.bg-light {
        background-color: #f8f9fa !important;
        border: 1px solid #e9ecef !important;
    }
    
    /* 未完成的比賽保持原樣 */
    .card:not(.bg-light) {
        background-color: #ffffff !important;
    }
    
    .bracket {
        display: flex;
        overflow-x: auto;
        padding: 20px;
    }
    .round {
        display: flex;
        flex-direction: column;
        justify-content: space-around;
        min-width: 220px;
        margin-right: 50px;
    }
    .round-title {
        font-weight: bold;
        text-align: center;
    }
    .match-list {
        display: flex;
        flex-direction: column;
        justify-content: space-around;
        flex-grow: 1;
    }
    .match-up {
        position: relative;
        margin: 20px 0;
    }
    /* 從比賽中間向右延伸的橫線 */
    .match-up::after {
        content: '';
        position: absolute;
        width: 25px;
        height: 2px;
        background-color: #999;
        left: 100%;
        top: 50%;
    }

    .participant {
        background-color: #fff;
        border: 1px solid #ddd;
        padding: 10px 15px;
        border-radius: 4px;
        display: flex;
        justify-content: space-between;
    }
    /* 上半部的隊伍，畫出右、下框線 */
    .participant-top {
        border-bottom: none;
        border-top-right-radius: 0;
        border-bottom-right-radius: 0;
    }
    /* 下半部的隊伍，畫出右、上框線 */
    .participant-bottom {
        border-top: none;
        border-top-right-radius: 0;
        border-bottom-right-radius: 0;
    }
    .participant.winner {
        font-weight: bold;
        border-color: #0d6efd;
    }
    .participant span:last-child {
        font-weight: bold;
    }

    /* --- 互動高亮樣式 --- */
    .participant.highlight {
        background-color: #ffc107;
        border-color: #ffc107;
    }
    .match-up.highlight-line::after {
        background-color: #ffc107 !important;
    }
    
    /* --- 雙淘汰賽樣式 --- */
    .upper-bracket {
        border-right: 2px solid #0d6efd;
        padding-right: 15px;
        margin-right: 15px;
    }
    .lower-bracket {
        border-left: 2px solid #dc3545;
        padding-left: 15px;
        margin-left: 15px;
    }
    .upper-bracket .round-title {
        color: #0d6efd;
        font-weight: 600;
    }
    .lower-bracket .round-title {
        color: #dc3545;
        font-weight: 600;
    }
    .upper-bracket .participant {
        border-left: 3px solid #0d6efd;
    }
    .lower-bracket .participant {
        border-left: 3px solid #dc3545;
    }
</style>

<h1 class="mb-3">{{ tournament.name }}</h1>

<!-- 操作按鈕區域 -->
<div class="mb-3">
    <a href="{% url 'tournament_stats' pk=tournament.pk %}" class="btn btn-info">
        <i class="fas fa-chart-bar"></i> 查看選手數據統計
    </a>
    
    {% if user.is_superuser %}
        {% if tournament.format == 'round_robin' %}
        <a href="{% url 'auto_random_grouping' pk=tournament.pk %}" class="btn btn-success">
            <i class="fas fa-random"></i> 自動隨機分組 (管理員)
        </a>
        {% endif %}
        
        <form method="post" action="{% url 'generate_tournament_schedule' pk=tournament.pk %}" style="display: inline;">
            {% csrf_token %}
            <button type="submit" class="btn btn-primary" onclick="return confirm('確定要自動產生賽程嗎？這將清除現有賽程並重新生成。')">
                <i class="fas fa-calendar-plus"></i> 自動排賽程 (管理員)
            </button>
        </form>
    {% endif %}
</div>

<p class="lead"><strong>遊戲項目：</strong> {{ tournament.game }}</p>

{% if tournament.format == 'round_robin' %}

    <h3 class="mt-5">分組賽況</h3>
    <hr>
    
    {% if current_group %}
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0" style="color: #0d6efd; font-size: 1.3rem; font-weight: 700;">
                    {{ current_group.name }}
                    <span class="ms-2" style="color: #000000; font-weight: bold;">({{ current_group.teams.count }} 支隊伍)</span>
                </h4>
            </div>
            <div class="card-body">
                <!-- 積分榜 -->
                <h6 class="mb-3">積分榜</h6>
                <table class="table table-striped table-sm mb-4">
                    <thead class="table-dark">
                        <tr>
                            <th>排名</th>
                            <th>隊伍</th>
                            <th>勝場</th>
                            <th>敗場</th>
                            <th>積分</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for standing in current_group.standings.all %}
                        <tr>
                            <td><strong class="text-primary">{{ forloop.counter }}</strong></td>
                            <td><strong class="team-name-black">{{ standing.team.name }}</strong></td>
                            <td><span class="text-success fw-bold">{{ standing.wins }}</span></td>
                            <td><span class="text-danger fw-bold">{{ standing.losses }}</span></td>
                            <td><span class="badge bg-primary fs-6">{{ standing.points }}</span></td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="5" class="text-center text-muted">此分組尚無積分資料。</td></tr>
                        {% endfor %}
                    </tbody>
                </table>

                <!-- 賽程 -->
                <h6 class="mb-3 text-primary">{{ current_group.name }} 賽程</h6>
                <div class="row">
                    {% for match in group_matches %}
                        <div class="col-md-6 mb-2">
                            <div class="card border-0 shadow-sm {% if match.status == 'completed' %}bg-light{% endif %}">
                                <div class="card-body p-2 d-flex justify-content-between align-items-center">
                                    <span class="text-truncate team-name-black" style="max-width: 40%;">{{ match.team1.name }}</span>
                                    <span class="badge bg-{% if match.status == 'completed' %}success{% else %}secondary{% endif %} mx-2 fs-6">
                                        {{ match.team1_score }} - {{ match.team2_score }}
                                    </span>
                                    <span class="text-truncate text-end team-name-black" style="max-width: 40%;">{{ match.team2.name }}</span>
                                </div>
                            </div>
                        </div>
                    {% empty %}
                        <div class="col-12">
                            <p class="text-center text-muted">此分組尚無賽程。</p>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    {% else %}
        <div class="alert alert-info" role="alert">
            此賽事尚無分組資訊。
        </div>
    {% endif %}

    <!-- 分組分頁導航 -->
    {% if groups.has_other_pages %}
        <nav aria-label="分組導航" class="mt-4">
            <ul class="pagination pagination-lg justify-content-center">
                {% if groups.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page=1">&laquo; 第一組</a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ groups.previous_page_number }}">上一組</a>
                    </li>
                {% endif %}
                
                <li class="page-item active">
                    <span class="page-link">
                        第 {{ groups.number }} 組 / 共 {{ groups.paginator.num_pages }} 組
                    </span>
                </li>
                
                {% if groups.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ groups.next_page_number }}">下一組</a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ groups.paginator.num_pages }}">最後一組 &raquo;</a>
                    </li>
                {% endif %}
            </ul>
            <div class="text-center text-muted">
                <small>總共 {{ groups.paginator.count }} 個分組</small>
            </div>
        </nav>
    {% endif %}

{% elif tournament.format == 'swiss' %}

    <div class="row">
        <div class="col-md-5">
            <h3 class="mt-5">總積分榜</h3>
            <hr>
            <table class="table table-striped table-sm">
                <thead>
                    <tr>
                        <th>排名</th><th>隊伍</th><th>積分</th><th>勝-敗</th>
                    </tr>
                </thead>
                <tbody>
                    {% for standing in standings %}
                    <tr>
                        <td>{{ forloop.counter }}</td>
                        <td>{{ standing.team.name }}</td>
                        <td>{{ standing.points }}</td>
                        <td>{{ standing.wins }} - {{ standing.losses }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="col-md-7">
            <h3 class="mt-5">各輪賽程</h3>
            <hr>
            {% for round_number, matches_in_round in rounds.items %}
                <h5 class="mt-3">第 {{ round_number }} 輪</h5>
                {% for match in matches_in_round %}
                    <div class="card mb-2">
                        <div class="card-body d-flex justify-content-between align-items-center p-2">
                            <span class="w-40 text-end">{{ match.team1.name }}</span>
                            <span class="badge bg-danger mx-2">{{ match.team1_score }} - {{ match.team2_score }}</span>
                            <span class="w-40 text-start">{{ match.team2.name }}</span>
                        </div>
                    </div>
                {% endfor %}
            {% empty %}
                <p>尚無比賽。</p>
            {% endfor %}
            
            <!-- 分頁導航 -->
            {% if page_matches.has_other_pages %}
                <nav aria-label="賽程分頁導航" class="mt-4">
                    <ul class="pagination pagination-sm justify-content-center">
                        {% if page_matches.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page=1">&laquo; 第一頁</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_matches.previous_page_number }}">上一頁</a>
                            </li>
                        {% endif %}
                        
                        <li class="page-item active">
                            <span class="page-link">
                                第 {{ page_matches.number }} 頁 / 共 {{ page_matches.paginator.num_pages }} 頁
                            </span>
                        </li>
                        
                        {% if page_matches.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_matches.next_page_number }}">下一頁</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_matches.paginator.num_pages }}">最後一頁 &raquo;</a>
                            </li>
                        {% endif %}
                    </ul>
                    <div class="text-center text-muted small">
                        共 {{ page_matches.paginator.count }} 場比賽
                    </div>
                </nav>
            {% endif %}
        </div>
    </div>

{% else %}

    <div class="row mt-4">
        <div class="col-12">
            <h3>對戰樹</h3>
            <hr>
            
            {% if tournament.format == 'double_elimination' %}
                <!-- 雙淘汰賽：分別顯示勝部和敗部 -->
                <div class="row">
                    <div class="col-md-6">
                        <h4 class="text-primary">勝部 (Upper Bracket)</h4>
                        <div class="bracket upper-bracket">
                            {% for round_number, matches_in_round in rounds.items %}
                                {% with upper_matches=matches_in_round|dictsort:"is_lower_bracket" %}
                                {% for match in upper_matches %}
                                    {% if not match.is_lower_bracket %}
                                        {% if forloop.first %}
                                            <div class="round">
                                                <h6 class="round-title">第 {{ round_number }} 輪</h6>
                                                <div class="match-list">
                                        {% endif %}
                                        
                                        <div class="match-up">
                                            <div class="participant {% if match.winner == match.team1 %}winner{% endif %} participant-top">
                                                <span>{{ match.team1.name | default:"待定" }}</span>
                                                <span>{{ match.team1_score }}</span>
                                            </div>
                                            <div class="participant {% if match.winner == match.team2 %}winner{% endif %} participant-bottom">
                                                <span>{{ match.team2.name | default:"待定" }}</span>
                                                <span>{{ match.team2_score }}</span>
                                            </div>
                                        </div>
                                        
                                        {% if forloop.last %}
                                                </div>
                                            </div>
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}
                                {% endwith %}
                            {% endfor %}
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <h4 class="text-danger">敗部 (Lower Bracket)</h4>
                        <div class="bracket lower-bracket">
                            {% for round_number, matches_in_round in rounds.items %}
                                {% with lower_matches=matches_in_round|dictsort:"is_lower_bracket" %}
                                {% for match in lower_matches %}
                                    {% if match.is_lower_bracket %}
                                        {% if forloop.first %}
                                            <div class="round">
                                                <h6 class="round-title">第 {{ round_number }} 輪</h6>
                                                <div class="match-list">
                                        {% endif %}
                                        
                                        <div class="match-up">
                                            <div class="participant {% if match.winner == match.team1 %}winner{% endif %} participant-top">
                                                <span>{{ match.team1.name | default:"待定" }}</span>
                                                <span>{{ match.team1_score }}</span>
                                            </div>
                                            <div class="participant {% if match.winner == match.team2 %}winner{% endif %} participant-bottom">
                                                <span>{{ match.team2.name | default:"待定" }}</span>
                                                <span>{{ match.team2_score }}</span>
                                            </div>
                                        </div>
                                        
                                        {% if forloop.last %}
                                                </div>
                                            </div>
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}
                                {% endwith %}
                            {% endfor %}
                        </div>
                    </div>
                </div>
            {% else %}
                <!-- 單淘汰賽：標準對戰樹 -->
                <div class="bracket">
                    {% for round_number, matches_in_round in rounds.items %}
                        <div class="round">
                            <h5 class="round-title">
                                {% if forloop.last %}
                                    決賽
                                {% elif forloop.revcounter == 2 %}
                                    準決賽
                                {% elif forloop.revcounter == 3 %}
                                    準準決賽
                                {% else %}
                                    第 {{ round_number }} 輪
                                {% endif %}
                            </h5>
                            <div class="match-list">
                                {% for match in matches_in_round %}
                                    <div class="match-up">
                                        <div class="participant {% if match.winner == match.team1 %}winner{% endif %} participant-top"
                                             id="participant-{{ match.id }}-{{ match.team1.id }}"
                                             data-team-id="{{ match.team1.id }}">
                                            <span>{{ match.team1.name | default:"待定" }}</span>
                                            <span>{{ match.team1_score }}</span>
                                        </div>
                                        <div class="participant {% if match.winner == match.team2 %}winner{% endif %} participant-bottom"
                                             id="participant-{{ match.id }}-{{ match.team2.id }}"
                                             data-team-id="{{ match.team2.id }}">
                                            <span>{{ match.team2.name | default:"待定" }}</span>
                                            <span>{{ match.team2_score }}</span>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        </div>
    </div>

{% endif %}
<div class="row mt-5">
    <div class="col-md-6">
        <h3>賽事規章</h3>
        <hr>
        <p>{{ tournament.rules|linebreaks }}</p>
    </div>
</div>

<a href="{% url 'tournament_list' %}" class="btn btn-secondary mt-4">返回賽事列表</a>
{% endblock %}